<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>แผนที่ของฉัน</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
        .controls {
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            display: flex;
            gap: 20px;
        }
        .input-section {
            flex: 1;
        }
        #locationInput {
            width: 100%;
            height: 300px;
            margin-bottom: 10px;
            font-family: sans-serif;
            white-space: pre;
            padding: 10px;
        }
        .instructions {
            font-size: 0.9em;
            margin-bottom: 10px;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
        }
        .example {
            background: #fff;
            padding: 10px;
            border: 1px solid #ddd;
            margin-top: 10px;
            font-family: sans-serif;
        }
        .button-group {
            margin-top: 10px;
        }
        button {
            margin-right: 10px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <div class="input-section">
            <div class="instructions">
                กรุณาใส่ที่อยู่ในรูปแบบต่อไปนี้:
                <br><br>
                --- เริ่มต้นที่อยู่ด้วยขีด 3 ขีด ---<br>
                [ที่อยู่]<br>
                COLOR: [ชื่อสี]<br>
                --- จบที่อยู่ด้วยขีด 3 ขีด ---
                <br><br>
                สีที่ใช้ได้: red, blue, green, purple, orange, yellow, pink, black
                <div class="example">
---
99/99 ถนนสุขุมวิท
แขวงคลองเตย เขตคลองเตย
กรุงเทพมหานคร 10110
ประเทศไทย
COLOR: red
---</div>
            </div>
            <textarea id="locationInput" placeholder="กรุณาใส่ที่อยู่ตามรูปแบบด้านบน..."></textarea>
            <div class="button-group">
                <button onclick="addMarkers()">เพิ่มหมุด</button>
                <button onclick="clearMarkers()">ลบทั้งหมด</button>
                <button onclick="saveMarkers()">บันทึก</button>
                <button onclick="loadMarkers()">โหลด</button>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // Initialize the map centered on Thailand
        const map = L.map('map').setView([13.7563, 100.5018], 6);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let markers = [];
        const validColors = ['red', 'blue', 'green', 'purple', 'orange', 'yellow', 'pink', 'black'];

        // Create custom colored icon
        function createColoredIcon(color) {
            return L.divIcon({
                className: 'custom-pin',
                html: `<svg width="25" height="41" viewBox="0 0 100 100">
                    <path fill="${color}" d="M50 0C29.86 0 13.23 16.63 13.23 36.77c0 3.271.43 6.461 1.25 9.496C14.48 46.27 31.25 100 50 100c18.75 0 35.52-53.73 35.52-53.73a36.534 36.534 0 0 0 1.25-9.496C86.77 16.63 70.14 0 50 0z"/>
                </svg>`,
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            });
        }

        // Geocode address using Nominatim with Thailand region bias
        async function geocodeAddress(address) {
            // Add Thailand to the address if not present
            if (!address.toLowerCase().includes('thailand') && 
                !address.toLowerCase().includes('ประเทศไทย')) {
                address += ', ประเทศไทย';
            }

            const params = new URLSearchParams({
                format: 'json',
                q: address,
                countrycodes: 'th', // Limit to Thailand
                addressdetails: 1,
                'accept-language': 'th' // Request Thai language results
            });

            const response = await fetch(`https://nominatim.openstreetmap.org/search?${params.toString()}`, {
                headers: {
                    'Accept-Language': 'th'
                }
            });
            const data = await response.json();
            
            if (data.length === 0) throw new Error('ไม่พบที่อยู่');
            
            return {
                lat: parseFloat(data[0].lat),
                lng: parseFloat(data[0].lon),
                displayName: data[0].display_name
            };
        }

        // Parse input text into array of {address, color} objects
        function parseInput(text) {
            const addresses = [];
            const blocks = text.split('---').map(block => block.trim()).filter(block => block);
            
            for (const block of blocks) {
                const lines = block.split('\n').map(line => line.trim());
                const colorLine = lines.find(line => line.toLowerCase().startsWith('color:'));
                
                if (!colorLine) {
                    throw new Error('กรุณาระบุสีสำหรับหมุด');
                }
                
                const color = colorLine.split(':')[1].trim().toLowerCase();
                if (!validColors.includes(color)) {
                    throw new Error(`สีไม่ถูกต้อง "${color}". สีที่ใช้ได้: ${validColors.join(', ')}`);
                }
                
                const addressLines = lines.filter(line => !line.toLowerCase().startsWith('color:'));
                const fullAddress = addressLines.join(', ');
                
                addresses.push({
                    address: fullAddress,
                    color: color,
                    originalFormat: addressLines.join('\n')
                });
            }
            
            return addresses;
        }

        // Add markers from text input
        async function addMarkers() {
            const input = document.getElementById('locationInput').value;
            
            try {
                const locations = parseInput(input);
                const totalLocations = locations.length;
                let processed = 0;
                let errors = [];
                
                for (const loc of locations) {
                    try {
                        const geoData = await geocodeAddress(loc.address);
                        
                        const marker = L.marker([geoData.lat, geoData.lng], {
                            icon: createColoredIcon(loc.color)
                        })
                            .bindPopup(`<b>ที่อยู่:</b><br>${loc.originalFormat.replace(/\n/g, '<br>')}`)
                            .addTo(map);

                        markers.push({
                            marker: marker,
                            data: {
                                address: loc.originalFormat,
                                lat: geoData.lat,
                                lng: geoData.lng,
                                color: loc.color
                            }
                        });
                        
                        processed++;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } catch (error) {
                        errors.push(`ไม่พบที่อยู่:\n${loc.originalFormat}`);
                    }
                }

                if (markers.length > 0) {
                    const group = new L.featureGroup(markers.map(m => m.marker));
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                if (errors.length > 0) {
                    alert(`เพิ่มหมุดสำเร็จ ${processed} จาก ${totalLocations} ที่อยู่\n\nข้อผิดพลาด:\n${errors.join('\n\n')}`);
                } else {
                    alert(`เพิ่มหมุดสำเร็จทั้งหมด ${processed} ที่อยู่!`);
                }
            } catch (error) {
                alert(error.message);
            }
        }

        // Clear all markers
        function clearMarkers() {
            markers.forEach(m => map.removeLayer(m.marker));
            markers = [];
        }

        // Save markers to localStorage
        function saveMarkers() {
            const markerData = markers.map(m => m.data);
            localStorage.setItem('mapMarkers', JSON.stringify(markerData));
            alert('บันทึกหมุดเรียบร้อย!');
        }

        // Load markers from localStorage
        function loadMarkers() {
            const savedMarkers = localStorage.getItem('mapMarkers');
            if (savedMarkers) {
                clearMarkers();
                JSON.parse(savedMarkers).forEach(data => {
                    const marker = L.marker([data.lat, data.lng], {
                        icon: createColoredIcon(data.color)
                    })
                        .bindPopup(`<b>ที่อยู่:</b><br>${data.address.replace(/\n/g, '<br>')}`)
                        .addTo(map);
                    
                    markers.push({
                        marker: marker,
                        data: data
                    });
                });
                
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers.map(m => m.marker));
                    map.fitBounds(group.getBounds().pad(0.1));
                }
                alert('โหลดหมุดเรียบร้อย!');
            } else {
                alert('ไม่พบหมุดที่บันทึกไว้');
            }
        }
    </script>
</body>
</html>
