<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Google Maps - Multiple Thai Addresses</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        .controls {
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            display: flex;
            gap: 20px;
        }
        .input-section {
            flex: 1;
        }
        #addressInput {
            width: 100%;
            height: 200px;
            margin-bottom: 10px;
            font-family: sans-serif;
            padding: 10px;
        }
        .instructions {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
        }
        .button-group {
            margin-top: 10px;
        }
        button {
            margin-right: 10px;
            padding: 8px 16px;
            cursor: pointer;
        }
        .map-section {
            flex: 2;
        }
        .color-input {
            width: 100px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <div class="input-section">
            <div class="instructions">
                ใส่ที่อยู่แต่ละแห่งในบรรทัดใหม่ โดยใช้รูปแบบ:<br>
                ที่อยู่ | สี
                <br><br>
                ตัวอย่าง:<br>
                ถนนสุขุมวิท 55 กรุงเทพ | red<br>
                เซ็นทรัลเวิลด์ กรุงเทพ | blue<br>
                <br>
                สีที่ใช้ได้: red, blue, green, purple, orange, yellow, pink, black
            </div>
            <textarea id="addressInput" placeholder="ใส่ที่อยู่ตามรูปแบบด้านบน..."></textarea>
            <div class="button-group">
                <button onclick="addMarkers()">เพิ่มหมุด</button>
                <button onclick="clearMarkers()">ลบทั้งหมด</button>
                <button onclick="saveMarkers()">บันทึก</button>
                <button onclick="loadMarkers()">โหลด</button>
            </div>
        </div>
        <div class="map-section">
            <div id="map"></div>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        const validColors = ['red', 'blue', 'green', 'purple', 'orange', 'yellow', 'pink', 'black'];
        let geocoder;

        // Initialize the map
        function initMap() {
            // Create geocoder instance
            geocoder = new google.maps.Geocoder();

            // Initialize map centered on Thailand
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 6,
                center: { lat: 13.7563, lng: 100.5018 }, // Bangkok coordinates
            });
        }

        // Parse input text into array of {address, color} objects
        function parseInput(text) {
            const lines = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            return lines.map(line => {
                const [address, color] = line.split('|').map(part => part.trim());
                
                if (!address || !color) {
                    throw new Error(`รูปแบบไม่ถูกต้อง: ${line}\nต้องใช้รูปแบบ "ที่อยู่ | สี"`);
                }
                
                if (!validColors.includes(color.toLowerCase())) {
                    throw new Error(`สีไม่ถูกต้อง "${color}"\nสีที่ใช้ได้: ${validColors.join(', ')}`);
                }

                return {
                    address: address,
                    color: color.toLowerCase()
                };
            });
        }

        // Add markers from textarea input
        async function addMarkers() {
            const input = document.getElementById('addressInput').value;
            
            try {
                const locations = parseInput(input);
                const bounds = new google.maps.LatLngBounds();
                let processed = 0;
                let errors = [];

                for (const loc of locations) {
                    try {
                        // Add Thailand to the address if not present
                        const searchAddress = loc.address + (
                            loc.address.toLowerCase().includes('ประเทศไทย') || 
                            loc.address.toLowerCase().includes('thailand') ? 
                            '' : ', ประเทศไทย'
                        );

                        // Geocode the address
                        const result = await new Promise((resolve, reject) => {
                            geocoder.geocode(
                                { 
                                    address: searchAddress,
                                    region: 'th' // Bias to Thailand
                                }, 
                                (results, status) => {
                                    if (status === 'OK') {
                                        resolve(results[0]);
                                    } else {
                                        reject(new Error(status));
                                    }
                                }
                            );
                        });

                        const position = result.geometry.location;
                        
                        // Create marker with custom color
                        const marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: loc.address,
                            icon: {
                                path: google.maps.SymbolPath.MARKER,
                                fillColor: loc.color,
                                fillOpacity: 1,
                                strokeColor: '#000',
                                strokeWeight: 1,
                                scale: 10
                            }
                        });

                        // Add info window
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="font-family: sans-serif;">
                                <b>ที่อยู่:</b><br>${loc.address}<br>
                                <b>พิกัด:</b><br>
                                Latitude: ${position.lat()}<br>
                                Longitude: ${position.lng()}
                            </div>`
                        });

                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });

                        markers.push({
                            marker: marker,
                            data: {
                                address: loc.address,
                                color: loc.color,
                                lat: position.lat(),
                                lng: position.lng()
                            }
                        });

                        bounds.extend(position);
                        processed++;

                        // Add delay to avoid hitting API rate limits
                        await new Promise(resolve => setTimeout(resolve, 200));
                    } catch (error) {
                        errors.push(`ไม่พบที่อยู่: ${loc.address}`);
                    }
                }

                // Fit map to show all markers
                if (markers.length > 0) {
                    map.fitBounds(bounds);
                }

                if (errors.length > 0) {
                    alert(`เพิ่มหมุดสำเร็จ ${processed} จาก ${locations.length} ที่อยู่\n\nข้อผิดพลาด:\n${errors.join('\n')}`);
                } else {
                    alert(`เพิ่มหมุดสำเร็จทั้งหมด ${processed} ที่อยู่!`);
                }
            } catch (error) {
                alert(error.message);
            }
        }

        // Clear all markers
        function clearMarkers() {
            markers.forEach(m => m.marker.setMap(null));
            markers = [];
        }

        // Save markers to localStorage
        function saveMarkers() {
            const markerData = markers.map(m => m.data);
            localStorage.setItem('mapMarkers', JSON.stringify(markerData));
            alert('บันทึกหมุดเรียบร้อย!');
        }

        // Load markers from localStorage
        function loadMarkers() {
            const savedMarkers = localStorage.getItem('mapMarkers');
            if (savedMarkers) {
                clearMarkers();
                const bounds = new google.maps.LatLngBounds();

                JSON.parse(savedMarkers).forEach(data => {
                    const position = new google.maps.LatLng(data.lat, data.lng);
                    
                    const marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: data.address,
                        icon: {
                            path: google.maps.SymbolPath.MARKER,
                            fillColor: data.color,
                            fillOpacity: 1,
                            strokeColor: '#000',
                            strokeWeight: 1,
                            scale: 10
                        }
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div style="font-family: sans-serif;">
                            <b>ที่อยู่:</b><br>${data.address}<br>
                            <b>พิกัด:</b><br>
                            Latitude: ${data.lat}<br>
                            Longitude: ${data.lng}
                        </div>`
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });

                    markers.push({
                        marker: marker,
                        data: data
                    });

                    bounds.extend(position);
                });

                if (markers.length > 0) {
                    map.fitBounds(bounds);
                }
                alert('โหลดหมุดเรียบร้อย!');
            } else {
                alert('ไม่พบหมุดที่บันทึกไว้');
            }
        }
    </script>
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8BGrBTMnpGeBAJaPc5UZJRmhi_Yp9vYk&callback=initMap">
    </script>
</body>
</html>
